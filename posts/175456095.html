<!DOCTYPE html>
<html lang="zh-CN">


<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/MyBlog-GitHub/image-upload@main/uPic/1GsaSI.png">
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/MyBlog-GitHub/image-upload@main/uPic/1GsaSI.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>为你的网站加入深色模式 - YFun&#39;s Blog</title>
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hifun-team/hexo-theme-miracle@latest/source/icon/css/all.min.css">
    
    
    <meta name="description" content="探寻一切有趣的事物！">
    <meta name="author" content="YFun">
    <meta name="keywords" content="YFun博客,分享,免费,学习,yfun的博客,oCoke,HiFun,分享,知识,免费,薅羊毛,交流">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>



    <link rel="stylesheet" href="/css/main.min.css">
    <style>.hljs-comment,.hljs-quote{color:#969896;}.hljs-variable,.hljs-template-variable,.hljs-tag,.hljs-name,.hljs-selector-id,.hljs-selector-class,.hljs-regexp,.hljs-deletion{color:#cc6666;}.hljs-number,.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-type,.hljs-params,.hljs-meta,.hljs-link{color:#de935f;}.hljs-attribute{color:#f0c674;}.hljs-string,.hljs-symbol,.hljs-bullet,.hljs-addition{color:#b5bd68;}.hljs-title,.hljs-section{color:#81a2be;}.hljs-keyword,.hljs-selector-tag{color:#b294bb;}.hljs{display:block;overflow-x:auto;background:#1d1f21;color:#c5c8c6;padding:0.5em;}.hljs-emphasis{font-style:italic;}.hljs-strong{font-weight:bold;}
</style>
<style>
    :root{
        --shadow-color: rgba(0,0,0,0.2);
        --sec-shadow: rgba(0,0,0,0.1);
        --shadow-hover-color: rgba(0,0,0,0.28);
        --first-text-color: #484848;
        --second-text-color: #4c4c4c;
        --third-text-color: #858585;
        --default-text-color: #505050;
        --default-link-color: #007bff;
        --link-color: #000000;
        --second-link-color: #4F9BFA;
        --post-bkg-color: #fdfdfd;
        --page-bkg-color: #ffffff;
        --nav-bkg-color: rgba(253,253,253,0.5);
        --nav-a-hover-color: #3498db;
        --post-sec-text-color: #718096;
        --sec-bkg: #f2f5f8;
        --color-mode: 'light';
    }


@media (prefers-color-scheme: dark) {
  :root {
    --color-mode: 'dark';
  }

  :root:not([data-user-color-scheme]) {
    --shadow-color: rgba(0,0,0,0.2);
    --shadow-hover-color: rgba(0,0,0,0.28);
    --first-text-color: #ddd;
    --second-text-color: #c4c6c9;
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #3b3b3c;
    --page-bkg-color: #3b3b3b;
    --nav-bkg-color: #3b3b3c;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
  }
}

[data-user-color-scheme='dark'] {
    --shadow-color: rgba(0,0,0,0.2);
    --shadow-hover-color: rgba(0,0,0,0.28);
    --first-text-color: #ddd;
    --second-text-color: #c4c6c9;
    --third-text-color: #a7a9ad;
    --default-text-color: #505050;
    --default-link-color: #1589e9;
    --link-color: #000000;
    --second-link-color: #30a9de;
    --post-bkg-color: #3b3b3c;
    --page-bkg-color: #3b3b3b;
    --nav-bkg-color: #3b3b3c;
    --nav-a-hover-color: #3498db;
    --post-sec-text-color: #a7a9ad;
    --sec-bkg: #364151;
}

</style>



     <!-- Google Adsense --> <script data-ad-client="ca-pub-5902069866611465" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> 
<meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="YFun's Blog" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="YFun's Blog" type="application/rss+xml">
</head>

    <body>
        
            <div class="c-loading">
                <svg width="35px" height="35px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                    <g>
                      <animateTransform attributeName="transform" type="rotate" values="0 33 33;270 33 33" begin="0s" dur="1.4s" fill="freeze" repeatCount="indefinite"/>
                      <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30" stroke-dasharray="187" stroke-dashoffset="610">
                        <animate attributeName="stroke" values="#4285F4;#DE3E35;#F7C223;#1B9A59;#4285F4" begin="0s" dur="5.6s" fill="freeze" repeatCount="indefinite"/>
                        <animateTransform attributeName="transform" type="rotate" values="0 33 33;135 33 33;450 33 33" begin="0s" dur="1.4s" fill="freeze" repeatCount="indefinite"/>
                        <animate attributeName="stroke-dashoffset" values="187;46.75;187" begin="0s" dur="1.4s" fill="freeze" repeatCount="indefinite"/>
                      </circle>
                     </g>
                  </svg>
            </div>
        
        <header>
            <div class="c-nav">
	<div class="container navFlex">
		<div class="flexItem">
      		<a href="/">
        		<h1 class="logo">YFun&#39;s Blog</h1>
      		</a>
		</div>
		
		<div class="flexItem hiden logo">
			<i class="fa fa-bars btnImg"></i>
		</div>
		<div class="flexItem show">
			<ul>
				
          			<li><a href="/">首页</a></li>
				
          			<li><a href="/archives">归档</a></li>
				
          			<li><a href="/categories">分类</a></li>
				
          			<li><a href="/tags">标签</a></li>
				
          			<li><a href="/talk">说说</a></li>
				
          			<li><a href="/links">友链</a></li>
				
          			<li><a href="/about/">关于</a></li>
				
				
				<li><a href="/search/" id="search-btn"><i class="fas fa-search meta-icon"></i></a></li>
				
				
				<li><a href="javascript:;"><i class="fas fa-moon meta-icon" id="toggle-dark-icon"></i></a></li>
				
			</ul>
		</div>
	</div>
</div>

        </header>
        <div id="page-main" class="main-content">
        <div class="mg-top">
            

<div id="post-meta-m">
    <div class="post-meta" id="post-meta">
  <h3>为你的网站加入深色模式</h3>
    
      <span class="post-meta-label">
        <i class="fa fa-user meta-icon" aria-hidden="true"></i>
        YFun
      </span>
    
    
      <span class="post-meta-label ml-10">
        <i class="fa fa-calendar meta-icon" aria-hidden="true"></i>
        <time datetime="2021-01-22 12:29" pubdate>
          2021年1月22日
        </time>
      </span>
    
    
      
      <span class="post-meta ml-10">
        <i class="fa fa-file-word meta-icon"></i>
        共 2.7k 字
      </span>
    
    
      
      <span class="post-meta ml-10">
        <i class="fa fa-clock meta-icon"></i>
        
        预计 
        27
         分钟
      </span>
    
    
  </div>
  
  
</div>
<div class="article-m">
  <div class="post-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E3%80%8C%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E3%80%8D"><span class="toc-number">1.</span> <span class="toc-text">什么是「深色模式」</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Media-Query-%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">利用 Media Query 简单实现深色模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSS-Variable-%E7%9A%84%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">CSS Variable 的方法实现深色模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E5%8D%95%E7%8B%AC%E7%BC%96%E5%86%99%E6%A0%B7%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">为深色模式单独编写样式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%80%A7%E5%8A%A0%E8%BD%BD%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E7%9A%84-CSS-%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.</span> <span class="toc-text">条件性加载深色模式的 CSS 文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%8C%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E3%80%8D%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">「深色模式」的兼容性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E5%8F%8B%E5%A5%BD%E7%9A%84%E3%80%8C%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E3%80%8D"><span class="toc-number">4.</span> <span class="toc-text">设计一个用户友好的「深色模式」</span></a></li></ol></div>
    <div id="article">
      <div id="post-content">
        <div class="note note-info">
            <div class="title">转载文章</div>原文标题：你好黑暗，我的老朋友 —— 为网站添加用户友好的深色模式支持<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.skk.moe/post/hello-darkmode-my-old-friend/">https://blog.skk.moe/post/hello-darkmode-my-old-friend/</a><br>原文作者：Sukka</p>
          </div>

<p>前几天为我的 Hexo 主题：Miracle 加入了深色模式，但我的技术还是太辣鸡，经常出现问题。</p>
<p>无意间看到 Sukka 大佬的文章：「你好黑暗，我的老朋友 —— 为网站添加用户友好的深色模式支持」，跟着文章重构了主题深色模式的代码，就转载过来方便学习。</p>
<h2 id="什么是「深色模式」"><a href="#什么是「深色模式」" class="headerlink" title="什么是「深色模式」"></a>什么是「深色模式」</h2><p>很多操作系统在日落后会自动切换到「深色模式」、并不意味着「深色模式」就是「夜间模式」。「夜间模式」用于夜晚的弱光环境，主要目的是保护眼睛、减少强光刺激、避免影响睡眠，不难理解为什么 macOS 的 Night Shift 会自动调节屏幕色温、Android（AOSP）到了夜间可以选择启用系统级「琥珀色」滤镜。</p>
<p>
                    <a data-fancybox="gallery" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/npm/sks@0.0.6/macos-settings.png">
                        <img   class="lazyload-img" src="https://cdn.jsdelivr.net/npm/sks@0.0.6/macos-settings.png" srcset="/img/loading.svg" data-srcset="https://cdn.jsdelivr.net/npm/sks@0.0.6/macos-settings.png"  >
                    </a>
                    </p>
<p>「深色模式」更像是一个主题，即使在白天也可以使用。不论是为了在 OLED 屏幕上省电、亦或是减少白光刺激护眼、亦或是暗色模式对色盲用户更加友好，总之 macOS 率先提出了系统级的「暗色模式」、并在 WebKit 中增加了对应的 Media Query，而后 Chromium、Firefox 先后跟进，如今兼容 <code>prefers-color-scheme</code> 的浏览器占有率已经高达 81.82%。</p>
<h2 id="利用-Media-Query-简单实现深色模式"><a href="#利用-Media-Query-简单实现深色模式" class="headerlink" title="利用 Media Query 简单实现深色模式"></a>利用 Media Query 简单实现深色模式</h2><p>CSS 媒体查询 <code>@media</code> 是一个足够强大的特性，可以有条件地将样式应用于文档和各种上下文中。<a target="_blank" rel="noopener" href="https://drafts.csswg.org/mediaqueries-5/">Media Queries Level 5 草案</a> 中提出了深色模式的判断方式 <code>prefers-color-scheme</code>，包含 <code>light</code>、<code>dark</code>、<code>no-preference</code> 三种值。而不支持 Media Queries 5 的浏览器会直接无视 CSS 中的 <code>prefers-color-scheme</code> Media Query，无需额外的代码即可优雅降级。</p>
<p>还记得我刚刚说过「深色模式更像一个主题」么？为网站新增深色模式就如同换肤功能；搭配 <code>prefers-color-scheme</code>，编写深色模式的思路就如同编写响应式一般、无需赘述，结合几段 Code Snippet 一笔带过：</p>
<h3 id="CSS-Variable-的方法实现深色模式"><a href="#CSS-Variable-的方法实现深色模式" class="headerlink" title="CSS Variable 的方法实现深色模式"></a>CSS Variable 的方法实现深色模式</h3><pre><code class="hljs css"><span class="hljs-selector-pseudo">:root</span> &#123;
  <span class="hljs-attribute">--text</span>: <span class="hljs-number">#333</span>;
&#125;

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme:</span> dark) &#123;
  <span class="hljs-selector-pseudo">:root</span> &#123;
    <span class="hljs-attribute">--color-text</span>: <span class="hljs-number">#fff</span>;
  &#125;
&#125;

<span class="hljs-selector-tag">body</span> &#123;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--color-text);
&#125;</code></pre>

<p>通过维护两套 CSS Variable，可以快速切换不同的配色方案。这种方法特点是所需代码较少，缺点是 CSS Variable 的兼容性较差，可能还需要引入额外的 Polyfill。</p>
<h3 id="为深色模式单独编写样式"><a href="#为深色模式单独编写样式" class="headerlink" title="为深色模式单独编写样式"></a>为深色模式单独编写样式</h3><pre><code class="hljs css"><span class="hljs-selector-tag">body</span> &#123;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
&#125;

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme:</span> dark) &#123;
  <span class="hljs-selector-tag">body</span> &#123;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  &#125;
&#125;</code></pre>

<p>直接维护两套样式的方法清晰直观、任何网站都可以基于这种方法进行改造。但会造成冗余代码、较难实现统一的风格、后期不易维护。</p>
<h3 id="条件性加载深色模式的-CSS-文件"><a href="#条件性加载深色模式的-CSS-文件" class="headerlink" title="条件性加载深色模式的 CSS 文件"></a>条件性加载深色模式的 CSS 文件</h3><pre><code class="hljs css"><span class="hljs-comment">/* main.css */</span>
<span class="hljs-selector-tag">body</span> &#123;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
&#125;

<span class="hljs-comment">/* dark.css */</span>
<span class="hljs-selector-tag">body</span> &#123;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
&#125;</code></pre>
<pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;main.css&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;dark.css&quot;</span> <span class="hljs-attr">media</span>=<span class="hljs-string">&quot;(prefers-color-scheme: dark)&quot;</span>&gt;</span></code></pre>

<p>利用 <code>&lt;link&gt;</code> 标签的 Media Query，甚至可以单独加载暗色模式的 CSS 文件。</p>
<blockquote>
<p>需要注意 CSS 选择器的权重，因此作为可选的 <code>dark.css</code> 一定要放在 <code>main.css</code> 之后加载。</p>
</blockquote>
<p>除了上述三种方式以外，使用 CSS <code>filter</code> 或 <code>mix-blend-mode</code> 还可以实现对网站整体色调的改变，可以确保配色风格的统一性。</p>
<h2 id="「深色模式」的兼容性"><a href="#「深色模式」的兼容性" class="headerlink" title="「深色模式」的兼容性"></a>「深色模式」的兼容性</h2><p>虽然有了优雅的 <code>prefers-color-scheme</code> 可以识别操作系统的显示模式，但是对于用户来说，仅依赖 Media Query 的「深色模式」并不能带来很好的体验。<br>首先是浏览器兼容性。虽然支持该特性的浏览器的市场占有率非常喜人，但是从版本号上来看却并不乐观：</p>
<p>
                    <a data-fancybox="gallery" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/npm/sks@0.0.6/caniuse.png">
                        <img   class="lazyload-img" src="https://cdn.jsdelivr.net/npm/sks@0.0.6/caniuse.png" srcset="/img/loading.svg" data-srcset="https://cdn.jsdelivr.net/npm/sks@0.0.6/caniuse.png"  >
                    </a>
                    </p>
<p>考虑到使用 Chormium 70 内核甚至 Tencent X5 内核的国产浏览器，大部分用户并没有机会体验到深色模式。除此以外，操作系统级别的「深色模式」实现也会受到 OEM 厂商的影响 —— 虽然 Android 10（AOSP）提供「深色模式」，但是一加的 OxygenOS 却将其深藏在系统主题设置里，没有自动切换、在 Quick Settings 里也没有快速的切换开关。</p>
<h2 id="设计一个用户友好的「深色模式」"><a href="#设计一个用户友好的「深色模式」" class="headerlink" title="设计一个用户友好的「深色模式」"></a>设计一个用户友好的「深色模式」</h2><p>受限于兼容性和复杂的操作系统，大部分网站依然在使用更传统的「开关」切换 —— 通过 toggle <code>&lt;html&gt;</code> 或<br><code>&lt;body&gt;</code> 的 class 属性实现在两套样式之间切换、并将开关的状态记忆在 localStorage 中的方法虽然有效，却是无奈之举，手动切换开关相比 <code>prefers-color-scheme</code> 也不够优雅。如果将「开关」和 <code>prefers-color-scheme</code> 结合起来，就可以带来更好的用户体验：</p>
<ul>
<li>对于不兼容的浏览器或操作系统，访客依然可以通过开关手动切换显示模式</li>
<li>对于兼容的浏览器或操作系统，Media Query 能够实现在两种显示模式之间切换</li>
<li>在兼容的浏览器或操作系统上，用户还可以通过开关 override 当前的显示模式</li>
</ul>
<p>在将两者组合在一起时，不能简单地用「开关」覆盖 <code>prefers-color-scheme</code>，否则用户触发开关、状态被永久记忆在 localStorage 之后，就变成了僵硬的手动模式。<br>举个例子。访客可能在操作系统还没有自动切换到「深色模式」时通过网站上的开关切换显示模式，经过一个夜晚后到了次日白天、访客再度访问网站时，自然希望不需要再切换开关、网站就能以常规的浅色模式显示。因此设计思路是当 <code>prefers-color-scheme</code> 的值发生改变（从 与用户需要的显示模式不同 变成 相同）时清空 localStorage 中储存的开关状态，此时显示模式切换回基于 Media Query 的「自动」模式。</p>
<p><strong>Talk is cheap, here goes the code.</strong></p>
<p>首先是 CSS：</p>
<pre><code class="hljs css"><span class="hljs-selector-pseudo">:root</span> &#123;
  <span class="hljs-attribute">--color-mode</span>: <span class="hljs-string">&#x27;light&#x27;</span>;
  <span class="hljs-attribute">--text</span>: <span class="hljs-number">#333</span>;
&#125;

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme:</span> dark) &#123;
  <span class="hljs-selector-pseudo">:root</span> &#123;
    <span class="hljs-attribute">--color-mode</span>: <span class="hljs-string">&#x27;dark&#x27;</span>;
  &#125;

  <span class="hljs-selector-pseudo">:root</span><span class="hljs-selector-pseudo">:not(</span><span class="hljs-selector-attr">[data-user-color-scheme]</span>) &#123;
    <span class="hljs-attribute">--text</span>: <span class="hljs-number">#eff</span>;
  &#125;
&#125;

<span class="hljs-selector-attr">[data-user-color-scheme=<span class="hljs-string">&#x27;dark&#x27;</span>]</span> &#123;
  <span class="hljs-attribute">--text</span>: <span class="hljs-number">#eff</span>;
&#125;

<span class="hljs-selector-tag">body</span> &#123;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--color-text);
&#125;</code></pre>

<p>真是令人看的头大，让我们逐行来看都是些什么：</p>
<ul>
<li>在 <code>:root</code> 下定义了一个 CSS Variable <code>--color-mode: light</code> 和在浅色模式下用到的 CSS Variable（比如使用深色 <code>#333</code> 作为主要字体颜色）。</li>
<li>使用 <code>prefers-color-scheme</code> 的 Media Query 定义深色模式下的 CSS Variable： <code>--color-mode: light</code> 。深色模式的样式（如浅色 <code>#eff</code> 作为主要字体颜色）要定义在 <code>:not([data-user-color-scheme])</code> 伪类下以避免「开关」的行为覆盖浏览器的样式。</li>
<li>为 <code>[data-user-color-scheme=&#39;dark&#39;]</code> 再定义一遍深色模式下用到的样式。<br>有了这段 CSS，不难理解深色模式何时会生效：当操作系统使用「深色模式」且 <code>&lt;html&gt;</code> 或 <code>&lt;body&gt;</code> 标签上没有 <code>data-user-color-scheme</code> 属性时、或者存在 <code>data-user-color-scheme</code> 属性且值为 <code>dark</code> 时。</li>
</ul>
<p>然后是困难的部分了：编写 JavaScript 为「开关」添加行为。</p>
<p>先定义一些常量：</p>
<pre><code class="hljs js"><span class="hljs-keyword">const</span> rootElement = <span class="hljs-built_in">document</span>.documentElement; <span class="hljs-comment">// &lt;html&gt;</span>
<span class="hljs-keyword">const</span> darkModeStorageKey = <span class="hljs-string">&#x27;user-color-scheme&#x27;</span>; <span class="hljs-comment">// 作为 localStorage 的 key</span>
<span class="hljs-keyword">const</span> darkModeMediaQueryKey = <span class="hljs-string">&#x27;--color-mode&#x27;</span>;
<span class="hljs-keyword">const</span> rootElementDarkModeAttributeName = <span class="hljs-string">&#x27;data-user-color-scheme&#x27;</span>;
<span class="hljs-keyword">const</span> darkModeTogglebuttonElement = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-comment">/* element id */</span>);</code></pre>

<p>接下来，用 <code>try &#123;&#125; catch (e) &#123;&#125;</code> 封装一下 localStorage 的操作，以应对 HTML5 Storage 被禁用、localStorage 被写满、localStorage 实现不完整的情况：</p>
<pre><code class="hljs js"><span class="hljs-keyword">const</span> setLS = <span class="hljs-function">(<span class="hljs-params">k, v</span>) =&gt;</span> &#123;
  <span class="hljs-keyword">try</span> &#123;
    <span class="hljs-built_in">localStorage</span>.setItem(k, v);
  &#125; <span class="hljs-keyword">catch</span> (e) &#123; &#125;
&#125;

<span class="hljs-keyword">const</span> removeLS = <span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> &#123;
  <span class="hljs-keyword">try</span> &#123;
    <span class="hljs-built_in">localStorage</span>.removeItem(k);
  &#125; <span class="hljs-keyword">catch</span> (e) &#123; &#125;
&#125;

<span class="hljs-keyword">const</span> getLS = <span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> &#123;
  <span class="hljs-keyword">try</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">localStorage</span>.getItem(k);
  &#125; <span class="hljs-keyword">catch</span> (e) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> <span class="hljs-comment">// 与 localStorage 中没有找到对应 key 的行为一致</span>
  &#125;
&#125;</code></pre>

<p>我们还需要一个函数读取当前 <code>prefers-color-scheme</code> 的方法。由于已经在 CSS 中定义了 <code>--color-mode</code>，所以在 JS 中直接读取就好了：</p>
<pre><code class="hljs js"><span class="hljs-keyword">const</span> getModeFromCSSMediaQuery = <span class="hljs-function">() =&gt;</span> &#123;
  <span class="hljs-keyword">const</span> res = getComputedStyle(rootElement).getPropertyValue(darkModeMediaQueryKey);
  <span class="hljs-keyword">if</span> (res.length) <span class="hljs-keyword">return</span> res.replace(<span class="hljs-regexp">/\&quot;/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).trim();
  <span class="hljs-keyword">return</span> res === <span class="hljs-string">&#x27;dark&#x27;</span> ? <span class="hljs-string">&#x27;dark&#x27;</span> : <span class="hljs-string">&#x27;light&#x27;</span>;
  
  <span class="hljs-comment">// 使用 matchMedia API 的写法会优雅的多</span>
  <span class="hljs-comment">// return window.matchMedia(&#x27;(prefers-color-scheme: dark)&#x27;).matches ? &#x27;dark&#x27; : &#x27;light&#x27;</span>
&#125;</code></pre>
<p>还记得我们需要自动取消手动模式回到 <code>prefers-color-scheme</code> 么？意味着我们需要一个函数清掉 LS、删掉 <code>&lt;html&gt;</code> 存在的 <code>data-user-color-scheme</code> 属性：</p>
<pre><code class="hljs js"><span class="hljs-keyword">const</span> resetRootDarkModeAttributeAndLS = <span class="hljs-function">() =&gt;</span> &#123;
  rootElement.removeAttribute(rootElementDarkModeAttributeName);
  removeLS(darkModeStorageKey);
&#125;</code></pre>

<p>接下来是起主要作用的函数了，负责为 <code>&lt;html&gt;</code> 标签修改 <code>data-user-color-scheme</code> 属性：</p>
<pre><code class="hljs js"><span class="hljs-keyword">const</span> validColorModeKeys = &#123;
  <span class="hljs-string">&#x27;dark&#x27;</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">&#x27;light&#x27;</span>: <span class="hljs-literal">true</span>
&#125;

<span class="hljs-keyword">const</span> applyCustomDarkModeSettings = <span class="hljs-function">(<span class="hljs-params">mode</span>) =&gt;</span> &#123;
  <span class="hljs-comment">// 接受从「开关」处传来的模式，或者从 localStorage 读取</span>
  <span class="hljs-keyword">const</span> currentSetting = mode || getLS(darkModeStorageKey);

  <span class="hljs-keyword">if</span> (currentSetting === getModeFromCSSMediaQuery()) &#123;
    <span class="hljs-comment">// 当用户自定义的显示模式和 prefers-color-scheme 相同时重置、恢复到自动模式</span>
    resetRootDarkModeAttributeAndLS();
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (validColorModeKeys[currentSetting]) &#123; <span class="hljs-comment">// 相比 Array#indexOf，这种写法 Uglify 后字节数更少</span>
    rootElement.setAttribute(rootElementDarkModeAttributeName, currentSetting);
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// 首次访问或从未使用过开关、localStorage 中没有存储的值，currentSetting 是 null</span>
    <span class="hljs-comment">// 或者 localStorage 被篡改，currentSetting 不是合法值</span>
    resetRootDarkModeAttributeAndLS();
  &#125;
&#125;</code></pre>
<p>当然，「开关」还需要一个函数，这个函数负责获取相反的显示模式，同时还要将新的模式写入 localStorage 存储起来：</p>
<pre><code class="hljs js"><span class="hljs-keyword">const</span> invertDarkModeObj = &#123;
  <span class="hljs-string">&#x27;dark&#x27;</span>: <span class="hljs-string">&#x27;light&#x27;</span>,
  <span class="hljs-string">&#x27;light&#x27;</span>: <span class="hljs-string">&#x27;dark&#x27;</span>
&#125;

<span class="hljs-keyword">const</span> toggleCustomDarkMode = <span class="hljs-function">() =&gt;</span> &#123;
  <span class="hljs-keyword">let</span> currentSetting = getLS(darkModeStorageKey);
  
  <span class="hljs-keyword">if</span> (validColorModeKeys[currentSetting]) &#123;
    <span class="hljs-comment">// 从 localStorage 中读取模式，并取相反的模式</span>
    currentSetting = invertDarkModeObj[currentSetting];
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentSetting === <span class="hljs-literal">null</span>) &#123;
    <span class="hljs-comment">// localStorage 中没有相关值，或者 localStorage 抛了 Error</span>
    <span class="hljs-comment">// 从 CSS 中读取当前 prefers-color-scheme 并取相反的模式</span>
    currentSetting = invertDarkModeObj[getModeFromCSSMediaQuery()];
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// 不知道出了什么幺蛾子，比如 localStorage 被篡改成非法值</span>
    <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 直接 return;</span>
  &#125;
  <span class="hljs-comment">// 将相反的模式写入 localStorage</span>
  setLS(darkModeStorageKey, currentSetting);

  <span class="hljs-keyword">return</span> currentSetting;
&#125;</code></pre>
<p>相关的函数都定义完了，是时候添加函数执行了：</p>
<pre><code class="hljs js"><span class="hljs-comment">// 当页面加载时，将显示模式设置为 localStorage 中自定义的值（如果有的话）</span>
applyCustomDarkModeSettings();

darkModeTogglebuttonElement.addEventListener(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;
  <span class="hljs-comment">// 当用户点击「开关」时，获得新的显示模式、写入 localStorage、并在页面上生效</span>
  applyCustomDarkModeSettings(toggleCustomDarkMode());
&#125;)</code></pre>

<p>我的博客也使用的这种实现，通过 Navbar 中的按钮体验一下吧！</p>
<div class="note note-info">
            <div class="title">转载文章</div>原文标题：你好黑暗，我的老朋友 —— 为网站添加用户友好的深色模式支持<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.skk.moe/post/hello-darkmode-my-old-friend/">https://blog.skk.moe/post/hello-darkmode-my-old-friend/</a><br>原文作者：Sukka</p>
          </div>
      </div>
          
            <br/>
            <hr/>
            <div id="p-meta-i">
                
                    <div class="post-meta mr-3">
                      <i class="fa fa-folder meta-icon"></i>
                      
                        &nbsp;&nbsp;&nbsp;<a class="hover-with-bg" href="/categories/%E6%9E%81%E5%AE%A2/">极客</a>
                      
                    </div>
                  
                  
                    <div class="post-meta">
                      <i class="fa fa-tags meta-icon"></i>
                      
                        &nbsp;&nbsp;<a class="hover-with-bg" href="/tags/%E5%8D%9A%E5%AE%A2/">博客</a>
                      
                        &nbsp;&nbsp;<a class="hover-with-bg" href="/tags/JavaScript/">JavaScript</a>
                      
                        &nbsp;&nbsp;<a class="hover-with-bg" href="/tags/Web/">Web</a>
                      
                        &nbsp;&nbsp;<a class="hover-with-bg" href="/tags/CSS/">CSS</a>
                      
                    </div>
                  
            </div>
          
          
          <br/>
          <div class="note note-warning">
            本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处，谢谢。
          </div>
          
    </div>
</div>

    <!-- Comments -->
    <div class="comments">
        
        
    <script src="https://cdn.jsdelivr.net/npm/twikoo@1.0.0/dist/twikoo.all.min.js"></script>
    <div id="miracle-comments">
        <div id="tcomment"></div>
    </div>
    <script>
        twikoo.init({
            envId: 'blog-5gsje14af285555e',
            el: '#tcomment',
            region: 'ap-guangzhou',
            path: 'window.location.pathname'
        })
    </script>


    </div>




        </div>
        </div>
        <footer class="text-center">
    
    
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme is <a href="https://github.com/hifun-team/hexo-theme-miracle" target="_blank">Miracle</a></p>
</footer>
<div class="p-btn">
    
        <a class="toc-btn" id="toc-btn"><i class="fas fa-indent"></i></a>
    
    <a href="#" class="click-btn"><i class="fas fa-chevron-up"></i></a>
</div>

<!-- SCRIPTS -->






<script>
    var toggle = true;
    // 导航栏按钮
    $('.btnImg').click(function() {
        if (toggle) {
            toggle = false
            $(".btnImg").removeClass("fa-bars");
            $(".btnImg").addClass("fa-times");
        } else {
            toggle = true;
            $(".btnImg").removeClass("fa-times");
            $(".btnImg").addClass("fa-bars");
        }
        $(".show").slideToggle(300);
    });
    // 窗口大小发生改变
    $(window).resize(function() {
        // 获取窗口宽度
        var windSize = $(window).width();

        if (windSize > 885) {
            $(".show").slideDown(0);
        }
    });
    
    var cToggle = true;
    $('.collapse .header').click(function() {
        if (cToggle) {
            cToggle = false
            $(".collapse .header .icon").removeClass("fas fa-chevron-down");
            $(".collapse .header .icon").addClass("fas fa-chevron-up");
        } else {
          cToggle = true;
          $(".collapse .header .icon").removeClass("fas fa-chevron-up");
          $(".collapse .header .icon").addClass("fas fa-chevron-down");
        }
        $(".collapse .content").slideToggle(250);
    });
    console.log('\n' + ' %c Powered by Hexo Theme Miracle ' + ' %c https://github.com/hifun-team/hexo-theme-miracle ' + '\n' + '\n', 'color: #fff; background: #4F9BFA; padding:5px 0;', 'background: #FFF; padding:5px 0;');
</script>

<script>
        document.onreadystatechange = function(){
            if(document.readyState == "complete"){
              $(".c-loading").addClass("display-none")
            }
        }
</script>


<script>
const rootElement = document.documentElement; // <html>
const darkModeStorageKey = 'user-color-scheme'; // 作为 localStorage 的 key
const darkModeMediaQueryKey = '--color-mode';
const rootElementDarkModeAttributeName = 'data-user-color-scheme';
const darkModeTogglebuttonElement = document.getElementById("toggle-dark-icon");
const setLS = (k, v) => {
  try {
    localStorage.setItem(k, v);
  } catch (e) { }
}

const removeLS = (k) => {
  try {
    localStorage.removeItem(k);
  } catch (e) { }
}

const getLS = (k) => {
  try {
    return localStorage.getItem(k);
  } catch (e) {
    return null // 与 localStorage 中没有找到对应 key 的行为一致
  }
}
const getModeFromCSSMediaQuery = () => {
  const res = getComputedStyle(rootElement).getPropertyValue(darkModeMediaQueryKey);
  if (res.length) return res.replace(/\"/g, '').trim();
  return res === 'dark' ? 'dark' : 'light';
  
  // 使用 matchMedia API 的写法会优雅的多
  // return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
}
const resetRootDarkModeAttributeAndLS = () => {
  rootElement.removeAttribute(rootElementDarkModeAttributeName);
  removeLS(darkModeStorageKey);
}
const validColorModeKeys = {
  'dark': true,
  'light': true
}

const applyCustomDarkModeSettings = (mode) => {
  // 接受从「开关」处传来的模式，或者从 localStorage 读取
  const currentSetting = mode || getLS(darkModeStorageKey);

  if (currentSetting === getModeFromCSSMediaQuery()) {
    // 当用户自定义的显示模式和 prefers-color-scheme 相同时重置、恢复到自动模式
    resetRootDarkModeAttributeAndLS();
  } else if (validColorModeKeys[currentSetting]) { // 相比 Array#indexOf，这种写法 Uglify 后字节数更少
    rootElement.setAttribute(rootElementDarkModeAttributeName, currentSetting);
  } else {
    // 首次访问或从未使用过开关、localStorage 中没有存储的值，currentSetting 是 null
    // 或者 localStorage 被篡改，currentSetting 不是合法值
    resetRootDarkModeAttributeAndLS();
  }
}
const invertDarkModeObj = {
  'dark': 'light',
  'light': 'dark'
}

const toggleCustomDarkMode = () => {
  let currentSetting = getLS(darkModeStorageKey);
  
  if (validColorModeKeys[currentSetting]) {
    // 从 localStorage 中读取模式，并取相反的模式
    currentSetting = invertDarkModeObj[currentSetting];
  } else if (currentSetting === null) {
    // localStorage 中没有相关值，或者 localStorage 抛了 Error
    // 从 CSS 中读取当前 prefers-color-scheme 并取相反的模式
    currentSetting = invertDarkModeObj[getModeFromCSSMediaQuery()];
  } else {
    // 不知道出了什么幺蛾子，比如 localStorage 被篡改成非法值
    return; // 直接 return;
  }
  // 将相反的模式写入 localStorage
  setLS(darkModeStorageKey, currentSetting);

  return currentSetting;
}
// 当页面加载时，将显示模式设置为 localStorage 中自定义的值（如果有的话）
applyCustomDarkModeSettings();
darkModeTogglebuttonElement.addEventListener('click', () => {
  // 当用户点击「开关」时，获得新的显示模式、写入 localStorage、并在页面上生效
  applyCustomDarkModeSettings(toggleCustomDarkMode());
});
</script>



    <link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>



    <script>
        var content=$(".lazyload-img");var preload=0;$(document).ready(function(){function load(){var scrollTop=document.body.scrollTop||document.documentElement.scrollTop;var winTop=window.innerHeight;for(var i=0;i<content.length;i++){if(content[i].offsetTop<=scrollTop+winTop+preload){if(!$(content[i]).attr("load")){var pageContentRaw=$(content[i]).attr("data-srcset");$(content[i]).attr('srcset',pageContentRaw);$(content[i]).attr("load",true)}}}}load();window.onscroll=function(){load()}});
    </script>


    <script src="https://cdn.jsdelivr.net/gh/hifun-team/hexo-theme-miracle@latest/source/js/hljs.js"></script>  
    <script>hljs.initHighlightingOnLoad();</script>


    <script>
        $(".toc-btn").click(function(){
            if ($('.post-toc').html()){
                $(".post-toc").toggleClass("display-inline");
            }else{
                alert("本文没有目录哦~");
            }
        });
    </script>










    </body>
</html>